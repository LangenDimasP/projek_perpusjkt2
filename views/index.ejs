<%- include('partials/header') %>

<!-- Main Header Section -->
<div class="flex flex-col md:flex-row md:items-center md:justify-between mb-8 bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-2xl border border-blue-100">
    <div class="flex items-center space-x-3">
        <div class="bg-blue-600 p-3 rounded-xl">
            <svg version="1.1" id="_x32_" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" 
	 class="w-8 h-8 text-white" viewBox="0 0 512 512"  xml:space="preserve">
<style type="text/css">
	.st0{fill:#ffffff;}
</style>
<g>
	<rect x="119.256" y="222.607" class="st0" width="50.881" height="50.885"/>
	<rect x="341.863" y="222.607" class="st0" width="50.881" height="50.885"/>
	<rect x="267.662" y="222.607" class="st0" width="50.881" height="50.885"/>
	<rect x="119.256" y="302.11" class="st0" width="50.881" height="50.885"/>
	<rect x="267.662" y="302.11" class="st0" width="50.881" height="50.885"/>
	<rect x="193.46" y="302.11" class="st0" width="50.881" height="50.885"/>
	<rect x="341.863" y="381.612" class="st0" width="50.881" height="50.885"/>
	<rect x="267.662" y="381.612" class="st0" width="50.881" height="50.885"/>
	<rect x="193.46" y="381.612" class="st0" width="50.881" height="50.885"/>
	<path class="st0" d="M439.277,55.046h-41.376v39.67c0,14.802-12.195,26.84-27.183,26.84h-54.025
		c-14.988,0-27.182-12.038-27.182-26.84v-39.67h-67.094v39.297c0,15.008-12.329,27.213-27.484,27.213h-53.424
		c-15.155,0-27.484-12.205-27.484-27.213V55.046H72.649c-26.906,0-48.796,21.692-48.796,48.354v360.246
		c0,26.661,21.89,48.354,48.796,48.354h366.628c26.947,0,48.87-21.692,48.87-48.354V103.4
		C488.147,76.739,466.224,55.046,439.277,55.046z M453.167,462.707c0,8.56-5.751,14.309-14.311,14.309H73.144
		c-8.56,0-14.311-5.749-14.311-14.309V178.089h394.334V462.707z"/>
	<path class="st0" d="M141.525,102.507h53.392c4.521,0,8.199-3.653,8.199-8.144v-73.87c0-11.3-9.27-20.493-20.666-20.493h-28.459
		c-11.395,0-20.668,9.192-20.668,20.493v73.87C133.324,98.854,137.002,102.507,141.525,102.507z"/>
	<path class="st0" d="M316.693,102.507h54.025c4.348,0,7.884-3.513,7.884-7.826V20.178C378.602,9.053,369.474,0,358.251,0H329.16
		c-11.221,0-20.349,9.053-20.349,20.178v74.503C308.81,98.994,312.347,102.507,316.693,102.507z"/>
</g>
</svg>
        </div>
        <div>
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800"><%= title %></h1>
            <p class="text-lg text-gray-600 mt-1 flex items-center">
                <svg class="w-5 h-5 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                Pilih event dan sesi yang Anda inginkan
            </p>
        </div>
    </div>
    
    <!-- Enhanced Filter Form -->
    <form id="filterForm" class="flex flex-col md:flex-row md:items-center md:space-x-3 space-y-3 md:space-y-0 mt-6 md:mt-0">
        <div class="relative">
            <svg class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2" fill="#939193" stroke="currentColor" version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" 
	 viewBox="0 0 550.196 550.196" xml:space="preserve">
<path d="M542.696,535.063h-20.668V254.297h6.584c4.143,0,7.5-3.357,7.5-7.5v-56.243c0-0.01,0-0.02,0-0.029v-0.064
	c0-0.068-0.008-0.134-0.01-0.202c-0.005-0.168-0.009-0.335-0.025-0.502c-0.012-0.124-0.032-0.245-0.05-0.368
	c-0.017-0.115-0.031-0.23-0.052-0.344c-0.028-0.147-0.065-0.291-0.102-0.435c-0.022-0.088-0.042-0.177-0.068-0.264
	c-0.044-0.149-0.096-0.295-0.149-0.44c-0.03-0.082-0.057-0.165-0.09-0.247c-0.055-0.137-0.117-0.27-0.18-0.402
	c-0.042-0.089-0.083-0.179-0.128-0.267c-0.061-0.116-0.127-0.227-0.193-0.339c-0.06-0.101-0.118-0.202-0.182-0.3
	c-0.062-0.094-0.128-0.184-0.193-0.274c-0.078-0.109-0.156-0.217-0.241-0.322c-0.063-0.078-0.131-0.152-0.197-0.228
	c-0.094-0.107-0.187-0.214-0.287-0.316c-0.074-0.075-0.152-0.145-0.229-0.217c-0.098-0.092-0.195-0.185-0.299-0.271
	c-0.102-0.086-0.209-0.164-0.316-0.245c-0.085-0.064-0.168-0.131-0.257-0.192c-0.155-0.107-0.315-0.204-0.478-0.299
	c-0.043-0.025-0.083-0.055-0.127-0.079c-0.006-0.003-0.031-0.017-0.042-0.023c-0.017-0.009-0.033-0.019-0.049-0.027
	c-3.374-1.879-106.794-59.512-143.564-84.132c-32.289-21.62-107.447-96.64-108.202-97.395c-2.93-2.928-7.677-2.928-10.606,0
	c-0.755,0.755-75.904,75.769-108.201,97.394c-36.773,24.622-140.222,82.271-143.567,84.133c-0.016,0.008-0.031,0.017-0.046,0.026
	c-0.012,0.007-0.038,0.021-0.044,0.024c-0.047,0.026-0.088,0.057-0.134,0.084c-0.159,0.093-0.317,0.188-0.469,0.292
	c-0.093,0.063-0.179,0.133-0.268,0.2c-0.103,0.078-0.206,0.153-0.305,0.236c-0.108,0.09-0.208,0.186-0.309,0.281
	c-0.073,0.069-0.148,0.135-0.218,0.207c-0.104,0.105-0.2,0.216-0.297,0.327c-0.063,0.072-0.127,0.142-0.187,0.216
	c-0.088,0.109-0.169,0.222-0.251,0.335c-0.062,0.086-0.125,0.171-0.183,0.26c-0.068,0.104-0.13,0.209-0.192,0.316
	c-0.063,0.106-0.126,0.212-0.183,0.322c-0.049,0.094-0.093,0.19-0.138,0.287c-0.059,0.126-0.119,0.252-0.171,0.382
	c-0.036,0.089-0.066,0.179-0.098,0.269c-0.05,0.139-0.099,0.277-0.141,0.419c-0.028,0.095-0.05,0.192-0.074,0.288
	c-0.034,0.136-0.07,0.272-0.096,0.411c-0.024,0.123-0.039,0.247-0.057,0.372c-0.016,0.113-0.035,0.226-0.046,0.341
	c-0.017,0.177-0.023,0.355-0.027,0.533c-0.001,0.059-0.009,0.116-0.009,0.175v0.057c0,0.014,0,0.028,0,0.042v56.238
	c0,4.143,3.358,7.5,7.5,7.5h6.584v280.767H7.5c-4.142,0-7.5,3.357-7.5,7.5s3.358,7.5,7.5,7.5h28.168h29.334h47.838h29.334h265.849
	h29.334h47.838h29.334h28.168c4.143,0,7.5-3.357,7.5-7.5S546.839,535.063,542.696,535.063z M169.94,112.187
	c28.741-19.245,87.152-76.204,105.158-93.987c18.005,17.783,76.419,74.743,105.16,93.988c26.655,17.847,85.763,51.64,119.659,70.771
	h-13.557c-4.143,0-7.5,3.357-7.5,7.5s3.357,7.5,7.5,7.5h34.753v41.337h-6.584h-29.334h-47.838h-29.334H142.174H112.84H65.002H35.668
	h-6.584V197.96h415.023c4.143,0,7.5-3.357,7.5-7.5s-3.357-7.5-7.5-7.5H50.279C84.175,163.828,143.286,130.034,169.94,112.187z
	 M477.694,254.297v280.767h-32.838V254.297H477.694z M400.522,254.297v280.767H149.674V254.297H400.522z M105.34,254.297v280.767
	H72.502V254.297H105.34z M43.168,535.063V254.297h14.334v280.767H43.168z M120.34,535.063V254.297h14.334v280.767H120.34z
	 M415.522,535.063V254.297h14.334v280.767H415.522z M492.694,535.063V254.297h14.334v280.767H492.694z"/>
</svg>
            <select name="filter" class="pl-10 pr-4 py-3 border border-gray-300 rounded-xl bg-white shadow-sm hover:border-blue-400 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all">
                <option value="Immersif" <%= currentFilter === 'Immersif' ? 'selected' : '' %>>Immersif</option>
                <option value="others" <%= currentFilter === 'others' ? 'selected' : '' %>>Event Lainnya</option>
            </select>
        </div>
        
        <div class="relative">
            <svg fill="#b6afac" class="w-7 h-7 absolute left-3 top-1/2 transform -translate-y-1/2"  viewBox="0 0 32 32" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;" version="1.1" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:serif="http://www.serif.com/" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="Icon"/><path d="M16,6c-5.519,0 -10,4.481 -10,10c0,5.519 4.481,10 10,10c5.519,0 10,-4.481 10,-10c0,-5.519 -4.481,-10 -10,-10Zm0,2c4.415,0 8,3.585 8,8c0,4.415 -3.585,8 -8,8c-4.415,0 -8,-3.585 -8,-8c0,-4.415 3.585,-8 8,-8Z"/><path d="M15.5,13l0,3c0,0.099 0.029,0.195 0.084,0.277l2,3c0.153,0.23 0.464,0.292 0.693,0.139c0.23,-0.153 0.292,-0.464 0.139,-0.693l-1.916,-2.874c0,-0 0,-2.849 0,-2.849c0,-0.276 -0.224,-0.5 -0.5,-0.5c-0.276,-0 -0.5,0.224 -0.5,0.5Z"/><path d="M7,16.5l4,-0c0.276,0 0.5,-0.224 0.5,-0.5c0,-0.276 -0.224,-0.5 -0.5,-0.5l-4,0c-0.276,0 -0.5,0.224 -0.5,0.5c0,0.276 0.224,0.5 0.5,0.5Z"/><path d="M15.5,7l0,4c0,0.276 0.224,0.5 0.5,0.5c0.276,-0 0.5,-0.224 0.5,-0.5l0,-4c0,-0.276 -0.224,-0.5 -0.5,-0.5c-0.276,-0 -0.5,0.224 -0.5,0.5Z"/><path d="M25,15.5l-4,0c-0.276,0 -0.5,0.224 -0.5,0.5c0,0.276 0.224,0.5 0.5,0.5l4,-0c0.276,0 0.5,-0.224 0.5,-0.5c0,-0.276 -0.224,-0.5 -0.5,-0.5Z"/><path d="M16.5,25l0,-4c0,-0.276 -0.224,-0.5 -0.5,-0.5c-0.276,-0 -0.5,0.224 -0.5,0.5l0,4c0,0.276 0.224,0.5 0.5,0.5c0.276,-0 0.5,-0.224 0.5,-0.5Z"/></svg>
            <select name="month" class="pl-10 pr-4 py-3 border border-gray-300 rounded-xl bg-white shadow-sm hover:border-blue-400 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all">
                <% const months = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"]; %>
                <% for(let i = 1; i <= 12; i++) { %>
                    <option value="<%= i %>" <%= currentMonth == i ? 'selected' : '' %>><%= months[i-1] %></option>
                <% } %>
            </select>
        </div>
        
        <div class="relative">
            <svg fill="#b6afac" class="w-7 h-7 absolute left-3 top-1/2 transform -translate-y-1/2"  viewBox="0 0 32 32" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;" version="1.1" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:serif="http://www.serif.com/" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="Icon"/><path d="M16,6c-5.519,0 -10,4.481 -10,10c0,5.519 4.481,10 10,10c5.519,0 10,-4.481 10,-10c0,-5.519 -4.481,-10 -10,-10Zm0,2c4.415,0 8,3.585 8,8c0,4.415 -3.585,8 -8,8c-4.415,0 -8,-3.585 -8,-8c0,-4.415 3.585,-8 8,-8Z"/><path d="M15.5,13l0,3c0,0.099 0.029,0.195 0.084,0.277l2,3c0.153,0.23 0.464,0.292 0.693,0.139c0.23,-0.153 0.292,-0.464 0.139,-0.693l-1.916,-2.874c0,-0 0,-2.849 0,-2.849c0,-0.276 -0.224,-0.5 -0.5,-0.5c-0.276,-0 -0.5,0.224 -0.5,0.5Z"/><path d="M7,16.5l4,-0c0.276,0 0.5,-0.224 0.5,-0.5c0,-0.276 -0.224,-0.5 -0.5,-0.5l-4,0c-0.276,0 -0.5,0.224 -0.5,0.5c0,0.276 0.224,0.5 0.5,0.5Z"/><path d="M15.5,7l0,4c0,0.276 0.224,0.5 0.5,0.5c0.276,-0 0.5,-0.224 0.5,-0.5l0,-4c0,-0.276 -0.224,-0.5 -0.5,-0.5c-0.276,-0 -0.5,0.224 -0.5,0.5Z"/><path d="M25,15.5l-4,0c-0.276,0 -0.5,0.224 -0.5,0.5c0,0.276 0.224,0.5 0.5,0.5l4,-0c0.276,0 0.5,-0.224 0.5,-0.5c0,-0.276 -0.224,-0.5 -0.5,-0.5Z"/><path d="M16.5,25l0,-4c0,-0.276 -0.224,-0.5 -0.5,-0.5c-0.276,-0 -0.5,0.224 -0.5,0.5l0,4c0,0.276 0.224,0.5 0.5,0.5c0.276,-0 0.5,-0.224 0.5,-0.5Z"/></svg>
            <select name="year" class="pl-10 pr-4 py-3 border border-gray-300 rounded-xl bg-white shadow-sm hover:border-blue-400 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all">
                <% const startYear = new Date().getFullYear(); %>
                <% for(let i = 0; i < 3; i++) { %>
                    <option value="<%= startYear + i %>" <%= currentYear == (startYear + i) ? 'selected' : '' %>><%= startYear + i %></option>
                <% } %>
            </select>
        </div>
    </form>
</div>

<% if (typeof events !== 'undefined' && events.length > 0 && events[0] != null) { %>
    <div class="space-y-8">
        <% events.forEach(event => { %>
            <div class="bg-white rounded-3xl shadow-xl overflow-hidden border border-gray-100 hover:shadow-2xl transition-all duration-300">
                <!-- Event Header -->
                <div class="bg-gradient-to-r from-blue-600 to-indigo-600 p-8 text-white">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <h2 class="text-3xl md:text-4xl font-bold mb-3"><%= event.name %></h2>
                            <div class="flex items-center space-x-2 text-blue-100 mb-4">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                                <span class="text-lg"><%= event.location %></span>
                            </div>
                            <p class="text-blue-50 text-lg leading-relaxed"><%= event.description %></p>
                        </div>
                        <div class="bg-white/10 backdrop-blur-sm rounded-2xl p-4 ml-6">
                            <svg class="w-12 h-12 text-white/80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                            </svg>
                        </div>
                    </div>
                </div>
                
                <% if (event.sessions && event.sessions.length > 0) { %>
                    <div class="p-8">
                        <div class="flex items-center space-x-3 mb-6">
                            <div class="bg-green-100 p-2 rounded-xl">
                                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                            </div>
                            <h3 class="text-2xl font-bold text-gray-800">Pilih Sesi</h3>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <% event.sessions.forEach(session => { %>
                                <div class="session-card group bg-gradient-to-br from-gray-50 to-white border-2 border-gray-200 rounded-2xl p-6 flex flex-col justify-between transform hover:-translate-y-2 hover:border-blue-300 hover:shadow-xl transition-all duration-300">
                                    <div class="space-y-4">
                                        <div class="flex items-center space-x-3">
                                            <div class="bg-blue-100 p-2 rounded-lg group-hover:bg-blue-200 transition-colors">
                                                <svg class="w-5 h-5 text-blue-600" viewBox="0 0 19 19" xmlns="http://www.w3.org/2000/svg">
  <path fill="none" stroke="currentColor" d="M161.960546,159.843246 L164.399107,161.251151 C164.637153,161.388586 164.71416,161.70086 164.580127,161.933013 C164.442056,162.172159 164.144067,162.258604 163.899107,162.117176 L161.419233,160.68542 C161.165323,160.8826 160.846372,161 160.5,161 C159.671573,161 159,160.328427 159,159.5 C159,158.846891 159.417404,158.291271 160,158.085353 L160,153.503423 C160,153.22539 160.231934,153 160.5,153 C160.776142,153 161,153.232903 161,153.503423 L161,158.085353 C161.582596,158.291271 162,158.846891 162,159.5 C162,159.6181 161.986351,159.733013 161.960546,159.843246 Z M160.5,169 C165.746705,169 170,164.746705 170,159.5 C170,154.253295 165.746705,150 160.5,150 C155.253295,150 151,154.253295 151,159.5 C151,164.746705 155.253295,169 160.5,169 Z M160.5,168 C165.19442,168 169,164.19442 169,159.5 C169,154.80558 165.19442,151 160.5,151 C155.80558,151 152,154.80558 152,159.5 C152,164.19442 155.80558,168 160.5,168 Z" transform="translate(-151 -150)"/>
</svg>
                                            </div>
                                            <div>
                                                <p class="font-bold text-gray-800 text-lg"><%= new Date(session.start_time).toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long' }) %></p>
                                                <p class="font-semibold text-blue-600"><%= new Date(session.start_time).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }) %> WIB</p>
                                            </div>
                                        </div>
                                        
                                        <div class="bg-amber-50 border border-amber-200 rounded-xl p-4">
                                            <div class="flex items-center space-x-2">
                                                <svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                                                </svg>
                                                <span class="text-amber-700 font-medium">Sisa Kuota:</span>
                                                <span class="font-bold text-amber-900 quota-display"><%= session.public_quota %></span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-6">
                                        <% if (user) { %>
                                            <% if (session.public_quota > 0) { %>
                                                <% if (session.status === 'UPCOMING' && new Date(session.booking_open_time) > new Date()) { %>
                                                    <div class="countdown-container bg-gradient-to-r from-amber-50 to-orange-50 border border-amber-200 p-4 rounded-xl text-center" data-open-time="<%= new Date(session.booking_open_time).toISOString() %>" data-session-id="<%= session.id %>">
                                                        <div class="flex items-center justify-center space-x-2 mb-2">
                                                            <svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                                            </svg>
                                                            <p class="text-amber-700 font-medium">Dibuka dalam:</p>
                                                        </div>
                                                        <p class="countdown-timer font-bold text-2xl text-amber-900"></p>
                                                    </div>
                                                    <button id="button-<%= session.id %>" data-session-id="<%= session.id %>" class="reserve-button hidden mt-4 w-full bg-gradient-to-r from-green-600 to-emerald-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg hover:from-green-700 hover:to-emerald-700 transform hover:scale-105 transition-all duration-200 flex items-center justify-center space-x-2">
                                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                                        </svg>
                                                        <span>Reservasi Sekarang</span>
                                                    </button>
                                                <% } else { %>
                                                    <button data-session-id="<%= session.id %>" class="reserve-button w-full bg-gradient-to-r from-green-600 to-emerald-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg hover:from-green-700 hover:to-emerald-700 transform hover:scale-105 transition-all duration-200 flex items-center justify-center space-x-2">
                                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                                        </svg>
                                                        <span>Reservasi Sekarang</span>
                                                    </button>
                                                <% } %>
                                            <% } else { %>
                                                <div class="w-full bg-gradient-to-r from-gray-300 to-gray-400 text-gray-600 font-bold py-3 px-6 rounded-xl cursor-not-allowed flex items-center justify-center space-x-2">
                                                    <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                                                        <line x1="15" y1="9" x2="9" y2="15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                                        <line x1="9" y1="9" x2="15" y2="15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                                    </svg>
                                                    <span>Kuota Habis</span>
                                                </div>
                                            <% } %>
                                        <% } else { %>
                                            <a href="/auth/login" class="w-full block bg-gradient-to-r from-gray-500 to-gray-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg hover:from-gray-600 hover:to-gray-700 transform hover:scale-105 transition-all duration-200 text-center flex items-center justify-center space-x-2">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"/>
                                                </svg>
                                                <span>Login untuk Reservasi</span>
                                            </a>
                                        <% } %>
                                    </div>
                                </div>
                            <% }) %>
                        </div>
                    </div>
                <% } else { %>
                    <div class="p-8 text-center">
                        <div class="bg-gray-50 rounded-2xl p-12">
                            <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <p class="text-xl text-gray-500 italic">Belum ada sesi yang tersedia untuk filter ini.</p>
                        </div>
                    </div>
                <% } %>
            </div>
        <% }) %>
    </div>
<% } else { %>
    <div class="text-center py-24">
        <div class="bg-gray-50 rounded-3xl p-16 max-w-2xl mx-auto">
            <svg fill="#000000" version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" 
	 class="w-20 h-20 text-gray-400 mx-auto mb-6" viewBox="0 0 552.855 552.855"
	 xml:space="preserve">
<g>
	<g>
		<path d="M511.889,157.413c-3.408-25.839-17.051-53.507-39.994-76.445c-22.949-22.95-50.619-36.598-76.463-40
			c-11.695-1.542-27.295-8.005-36.652-15.184C338.094,9.915,308.883,0,276.428,0s-61.665,9.915-82.351,25.784
			c-9.357,7.179-24.964,13.642-36.653,15.184c-25.845,3.403-53.513,17.05-76.463,40c-22.944,22.938-36.591,50.606-39.994,76.445
			c-1.542,11.695-8.005,27.308-15.184,36.665C9.915,214.763,0,243.974,0,276.428c0,32.455,9.915,61.666,25.784,82.352
			c7.179,9.357,13.642,24.975,15.184,36.664c3.409,25.84,17.05,53.508,39.994,76.445c22.95,22.949,50.619,36.598,76.463,40
			c11.695,1.543,27.295,8.006,36.653,15.184c20.686,15.869,49.896,25.783,82.351,25.783s61.666-9.914,82.351-25.783
			c9.357-7.178,24.963-13.641,36.652-15.184c25.844-3.402,53.514-17.051,76.463-40c22.943-22.938,36.586-50.605,39.994-76.445
			c1.543-11.695,8.006-27.307,15.184-36.664c15.869-20.686,25.783-49.896,25.783-82.352c0-32.454-9.914-61.665-25.783-82.35
			C519.895,184.72,513.432,169.102,511.889,157.413z M421.766,349.562c9.205,9.205,9.205,24.125,0,33.322l-38.881,38.881
			c-9.203,9.205-24.125,9.205-33.328,0l-73.128-73.133l-73.134,73.133c-9.205,9.205-24.125,9.205-33.33,0l-38.88-38.881
			c-9.205-9.203-9.205-24.125,0-33.322l73.14-73.135l-73.134-73.133c-9.205-9.205-9.205-24.125,0-33.324l38.88-38.88
			c9.205-9.204,24.125-9.204,33.33,0l73.128,73.134l73.134-73.134c9.205-9.204,24.125-9.204,33.33,0l38.879,38.88
			c9.205,9.205,9.205,24.125,0,33.324l-73.139,73.133L421.766,349.562z"/>
	</g>
</g>
</svg>
            <p class="text-2xl text-gray-500 font-medium">Tidak ada jadwal reservasi yang ditemukan untuk filter ini.</p>
        </div>
    </div>
<% } %>

<!-- Enhanced Modals -->
<div id="confirmationModal" class="fixed inset-0 w-full h-full bg-black bg-opacity-50 backdrop-blur-sm flex justify-center items-center hidden z-50 p-4">
    <div class="bg-white rounded-3xl p-8 max-w-2xl w-full shadow-2xl transform scale-95">
        <div id="confirmationModalContent"></div>
    </div>
</div>

<div id="successModal" class="fixed inset-0 w-full h-full bg-black bg-opacity-50 backdrop-blur-sm flex justify-center items-center hidden z-50 p-4">
    <div class="bg-white rounded-3xl p-8 max-w-md w-full text-center shadow-2xl">
        <div class="flex justify-center mb-6">
            <div class="bg-green-100 p-4 rounded-full">
                <svg class="w-16 h-16 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
            </div>
        </div>
        <h2 class="text-3xl font-bold mb-4 text-gray-800">Reservasi Berhasil!</h2>
        <p class="text-gray-600 mb-4">Kode reservasi Anda:</p>
        <p id="modalReservationCode" class="font-mono bg-gray-100 p-4 rounded-xl text-xl mb-6 border-2 border-dashed border-gray-300"></p>
        <p class="text-sm text-gray-500 mb-6">Lihat tiket di halaman Riwayat.</p>
        <button onclick="hideSuccessModal()" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-200">OK</button>
    </div>
</div>

<div id="errorModal" class="fixed inset-0 w-full h-full bg-black bg-opacity-50 backdrop-blur-sm flex justify-center items-center hidden z-50 p-4">
    <div class="bg-white rounded-3xl p-8 max-w-md w-full text-center shadow-2xl">
        <div class="flex justify-center mb-6">
            <div class="bg-red-100 p-4 rounded-full">
                <svg class="w-16 h-16 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
            </div>
        </div>
        <h2 class="text-3xl font-bold mb-4 text-gray-800">Reservasi Gagal!</h2>
        <p class="text-gray-600 mb-6" id="modalErrorMessage"></p>
        <button onclick="hideErrorModal()" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-200">Coba Lagi</button>
    </div>
</div>

<script>
    // --- ELEMENT REFERENCES ---
    const successModal = document.getElementById('successModal');
    const errorModal = document.getElementById('errorModal');
    const confirmationModal = document.getElementById('confirmationModal');
    const confirmationModalContent = document.getElementById('confirmationModalContent');
    let countdownInterval;

    // --- EVENT LISTENERS ---
    if (confirmationModal) {
        confirmationModal.addEventListener('click', function(event) {
            if (event.target === confirmationModal) {
                closeConfirmationModal();
            }
        });
    }

    window.addEventListener('load', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const bookingStatus = urlParams.get('booking');
        if (bookingStatus === 'success') {
            const code = urlParams.get('code');
            if (code) showSuccessModal(code);
        } else if (bookingStatus === 'failed') {
            const msg = urlParams.get('error');
            if (msg) showErrorModal(decodeURIComponent(msg));
        }
        if (bookingStatus) {
            window.history.replaceState({}, document.title, window.location.pathname);
        }
        const pendingSessionId = sessionStorage.getItem('pendingConfirmationSessionId');
        if (pendingSessionId) {
            const pendingButton = document.querySelector(`.reserve-button[data-session-id="${pendingSessionId}"]`);
            if (pendingButton) {
                openConfirmationModal(pendingSessionId, pendingButton);
            }
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.countdown-container').forEach(container => {
            const openTime = new Date(container.dataset.openTime).getTime();
            const timerElement = container.querySelector('.countdown-timer');
            const buttonElement = document.getElementById(`button-${container.dataset.sessionId}`);
            const interval = setInterval(() => {
                const distance = openTime - new Date().getTime();
                if (distance < 0) {
                    clearInterval(interval);
                    if (container) container.style.display = 'none';
                    if (buttonElement) buttonElement.style.display = 'block';
                    return;
                }
                const hours = String(Math.floor(distance / (1000 * 60 * 60))).padStart(2, '0');
                const minutes = String(Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60))).padStart(2, '0');
                const seconds = String(Math.floor((distance % (1000 * 60)) / 1000)).padStart(2, '0');
                if (timerElement) timerElement.innerHTML = `${hours}:${minutes}:${seconds}`;
            }, 1000);
        });

        document.querySelectorAll('.reserve-button').forEach(button => {
            button.addEventListener('click', (event) => {
                const sessionId = button.dataset.sessionId;
                openConfirmationModal(sessionId, event.currentTarget);
            });
        });
    });

    // --- FUNCTIONS ---
    function hideSuccessModal() { if(successModal) successModal.classList.add('hidden'); }
    function hideErrorModal() { if(errorModal) errorModal.classList.add('hidden'); }
    function showSuccessModal(code) { document.getElementById('modalReservationCode').textContent = code; if(successModal) successModal.classList.remove('hidden'); }
    function showErrorModal(message) { document.getElementById('modalErrorMessage').textContent = message; if(errorModal) errorModal.classList.remove('hidden'); }
    
    async function openConfirmationModal(sessionId, buttonElement) {
        if (!sessionId) {
        showErrorModal('Session ID tidak valid.');
        return;
    }
        const allBookingButtons = document.querySelectorAll('.reserve-button');
        try {
            allBookingButtons.forEach(btn => btn.disabled = true);
            console.log('Session ID:', sessionId);
            const response = await fetch(`/api/session/${sessionId}`);
            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.message || 'Gagal memuat detail sesi.');
            }
            const { session, bookingExpires } = await response.json();
            sessionStorage.setItem('pendingConfirmationSessionId', sessionId);

            confirmationModalContent.innerHTML = `
                <div class="text-center mb-8">
                    <div class="bg-blue-100 p-4 rounded-full inline-block mb-4">
                        <svg class="w-12 h-12 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                    <h2 class="text-3xl font-bold text-gray-800">Konfirmasi Reservasi Anda</h2>
                </div>
                <div id="timer-container" class="text-center mb-8 bg-gradient-to-r from-amber-50 to-orange-50 border border-amber-200 p-6 rounded-xl">
                    <div class="flex items-center justify-center space-x-2 mb-2">
                        <svg class="w-6 h-6 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <span class="text-amber-700 font-medium">Selesaikan konfirmasi dalam:</span>
                    </div>
                    <div id="countdown-timer" class="font-bold text-3xl text-amber-900"></div>
                </div>
                <div class="bg-gradient-to-r from-gray-50 to-blue-50 border border-gray-200 p-6 mb-8 rounded-xl">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <svg class="w-6 h-6 text-blue-600" viewBox="0 0 19 19" xmlns="http://www.w3.org/2000/svg">
  <path fill="none" stroke="currentColor" d="M161.960546,159.843246 L164.399107,161.251151 C164.637153,161.388586 164.71416,161.70086 164.580127,161.933013 C164.442056,162.172159 164.144067,162.258604 163.899107,162.117176 L161.419233,160.68542 C161.165323,160.8826 160.846372,161 160.5,161 C159.671573,161 159,160.328427 159,159.5 C159,158.846891 159.417404,158.291271 160,158.085353 L160,153.503423 C160,153.22539 160.231934,153 160.5,153 C160.776142,153 161,153.232903 161,153.503423 L161,158.085353 C161.582596,158.291271 162,158.846891 162,159.5 C162,159.6181 161.986351,159.733013 161.960546,159.843246 Z M160.5,169 C165.746705,169 170,164.746705 170,159.5 C170,154.253295 165.746705,150 160.5,150 C155.253295,150 151,154.253295 151,159.5 C151,164.746705 155.253295,169 160.5,169 Z M160.5,168 C165.19442,168 169,164.19442 169,159.5 C169,154.80558 165.19442,151 160.5,151 C155.80558,151 152,154.80558 152,159.5 C152,164.19442 155.80558,168 160.5,168 Z" transform="translate(-151 -150)"/>
</svg>
                            <span class="font-semibold text-gray-700">Waktu Mulai:</span>
                        </div>
                        <span class="font-bold text-gray-900">${new Date(session.start_time).toLocaleString('id-ID', { dateStyle: 'full', timeStyle: 'short' })}</span>
                    </div>
                </div>
                <form id="bookingForm">
                    <button id="confirm-button" type="submit" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-bold py-4 px-6 rounded-xl text-lg hover:from-blue-700 hover:to-indigo-700 transform hover:scale-105 transition-all duration-200 flex items-center justify-center space-x-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        <span>Konfirmasi Reservasi</span>
                    </button>
                </form>
                <div class="text-center mt-6">
                    <button onclick="closeConfirmationModal()" class="text-gray-500 hover:text-gray-700 hover:underline transition-colors duration-200 flex items-center justify-center space-x-2 mx-auto">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                        <span>Batal</span>
                    </button>
                </div>
            `;
            
            confirmationModal.classList.remove('hidden');
            startCountdown(bookingExpires);
            
            document.getElementById('bookingForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const confirmButton = document.getElementById('confirm-button');
                confirmButton.disabled = true;
                confirmButton.innerHTML = `
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span>Memproses...</span>
                `;

                const postResponse = await fetch('/booking/' + sessionId, { method: 'POST' });
                const result = await postResponse.json();
                closeConfirmationModal();
                if (postResponse.ok) {
                    showSuccessModal(result.code);
                    updateUIAfterBooking(buttonElement);
                } else {
                    showErrorModal(result.message);
                }
            });
        } catch (error) {
            showErrorModal(error.message);
        } finally {
            allBookingButtons.forEach(btn => btn.disabled = false);
        }
    }

    function closeConfirmationModal() {
        sessionStorage.removeItem('pendingConfirmationSessionId');
        clearInterval(countdownInterval);
        if (confirmationModal) confirmationModal.classList.add('hidden');
    }

    function startCountdown(expirationTime) {
        const countdownElement = document.getElementById('countdown-timer');
        const update = () => {
            const distance = expirationTime - Date.now();
            if (distance < 0) {
                clearInterval(countdownInterval);
                closeConfirmationModal();
                showErrorModal('Waktu konfirmasi habis.');
            } else {
                const minutes = String(Math.floor((distance / (1000 * 60)) % 60)).padStart(2, '0');
                const seconds = String(Math.floor((distance / 1000) % 60)).padStart(2, '0');
                if (countdownElement) countdownElement.textContent = `${minutes}:${seconds}`;
            }
        };
        update();
        countdownInterval = setInterval(update, 1000);
    }

    function updateUIAfterBooking(buttonElement) {
        const card = buttonElement.closest('.session-card');
        if (card) {
            const quotaDisplay = card.querySelector('.quota-display');
            if (quotaDisplay) {
                let currentQuota = parseInt(quotaDisplay.textContent, 10);
                if (!isNaN(currentQuota) && currentQuota > 0) {
                    quotaDisplay.textContent = currentQuota - 1;
                    if (currentQuota - 1 === 0) {
                        buttonElement.parentElement.innerHTML = `
                            <div class="w-full bg-gradient-to-r from-gray-300 to-gray-400 text-gray-600 font-bold py-3 px-6 rounded-xl cursor-not-allowed flex items-center justify-center space-x-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728L5.636 5.636m12.728 12.728L18.364 5.636M5.636 18.364l12.728-12.728"/>
                                </svg>
                                <span>Kuota Habis</span>
                            </div>
                        `;
                    }
                }
            }
        }
        const badge = document.getElementById('unread-count-badge');
        if (badge) {
            let currentCount = parseInt(badge.textContent, 10) || 0;
            badge.textContent = currentCount + 1;
            badge.classList.remove('hidden');
        }
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        const filterForm = document.getElementById('filterForm');
        filterForm.querySelectorAll('select').forEach(select => {
            select.addEventListener('change', function() {
                filterForm.submit();
            });
        });
    });
</script>

<%- include('partials/footer') %>