<%- include('partials/header') %>
<%- include('./partials/back-button') %>
<div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-lg overflow-hidden">
    <div class="grid grid-cols-1 md:grid-cols-3">
        <!-- FOTO PROFIL DAN BADGE ROLE -->
        <div class="md:col-span-1 bg-gray-50 p-8 border-r border-gray-200 flex flex-col items-center text-center">
            <!-- Avatar Sederhana -->
            <div class="w-32 h-32 bg-gray-200 rounded-full flex items-center justify-center mb-4 text-gray-600 font-bold text-5xl">
                <%= user.name.charAt(0).toUpperCase() %>
            </div>
            <h2 class="text-2xl font-bold text-gray-800"><%= user.name %></h2>
            <p class="text-gray-500"><%= user.email %></p>
            <div class="mt-4 inline-flex items-center space-x-2 text-sm font-medium px-3 py-1 rounded-full">
                <% if (user.role === 'ADMIN') { %>
                    <div class="inline-flex items-center space-x-1.5 bg-purple-100 text-purple-800 text-xs font-semibold px-2.5 py-1 rounded-full">
                        <svg fill="currentColor" class="w-4 h-4" viewBox="0 0 474.565 474.565"><g><path d="M255.204,102.3c-0.606-11.321-12.176-9.395-23.465-9.395C240.078,95.126,247.967,98.216,255.204,102.3z"/><path d="M134.524,73.928c-43.825,0-63.997,55.471-28.963,83.37c11.943-31.89,35.718-54.788,66.886-63.826C163.921,81.685,150.146,73.928,134.524,73.928z"/><path d="M43.987,148.617c1.786,5.731,4.1,11.229,6.849,16.438L36.44,179.459c-3.866,3.866-3.866,10.141,0,14.015l25.375,25.383c1.848,1.848,4.38,2.888,7.019,2.888c2.61,0,5.125-1.04,7.005-2.888l14.38-14.404c2.158,1.142,4.55,1.842,6.785,2.827c0-0.164-0.016-0.334-0.016-0.498c0-11.771,1.352-22.875,3.759-33.302c-17.362-11.174-28.947-30.57-28.947-52.715c0-34.592,28.139-62.739,62.723-62.739c23.418,0,43.637,13.037,54.43,32.084c11.523-1.429,22.347-1.429,35.376,1.033c-1.676-5.07-3.648-10.032-6.118-14.683l14.396-14.411c1.878-1.856,2.918-4.38,2.918-7.004c0-2.625-1.04-5.148-2.918-7.004l-25.361-25.367c-1.94-1.941-4.472-2.904-7.003-2.904c-2.532,0-5.063,0.963-6.989,2.904l-14.442,14.411c-5.217-2.764-10.699-5.078-16.444-6.825V9.9c0-5.466-4.411-9.9-9.893-9.9h-35.888c-5.451,0-9.909,4.434-9.909,9.9v20.359c-5.73,1.747-11.213,4.061-16.446,6.825L75.839,22.689c-1.942-1.941-4.473-2.904-7.005-2.904c-2.531,0-5.077,0.963-7.003,2.896L36.44,48.048c-1.848,1.864-2.888,4.379-2.888,7.012c0,2.632,1.04,5.148,2.888,7.004l14.396,14.403c-2.75,5.218-5.063,10.708-6.817,16.438H23.675c-5.482,0-9.909,4.441-9.909,9.915v35.889c0,5.458,4.427,9.908,9.909,9.908H43.987z"/><path d="M354.871,340.654c15.872-8.705,26.773-25.367,26.773-44.703c0-28.217-22.967-51.168-51.184-51.168c-9.923,0-19.118,2.966-26.975,7.873c-4.705,18.728-12.113,36.642-21.803,52.202C309.152,310.022,334.357,322.531,354.871,340.654z"/><path d="M460.782,276.588c0-5.909-4.799-10.693-10.685-10.693H428.14c-1.896-6.189-4.411-12.121-7.393-17.75l15.544-15.544c2.02-2.004,3.137-4.721,3.137-7.555c0-2.835-1.118-5.553-3.137-7.563l-27.363-27.371c-2.08-2.09-4.829-3.138-7.561-3.138c-2.734,0-5.467,1.048-7.547,3.138l-15.576,15.552c-5.623-2.982-11.539-5.481-17.751-7.369v-21.958c0-5.901-4.768-10.685-10.669-10.685H311.11c-2.594,0-4.877,1.04-6.739,2.578c3.26,11.895,5.046,24.793,5.046,38.552c0,8.735-0.682,17.604-1.956,26.423c7.205-2.656,14.876-4.324,22.999-4.324c36.99,0,67.086,30.089,67.086,67.07c0,23.637-12.345,44.353-30.872,56.303c13.48,14.784,24.195,32.324,31.168,51.976c1.148,0.396,2.344,0.684,3.54,0.684c2.733,0,5.467-1.04,7.563-3.13l27.379-27.371c2.004-2.004,3.106-4.721,3.106-7.555s-1.102-5.551-3.106-7.563l-15.576-15.552c2.982-5.621,5.497-11.555,7.393-17.75h21.957c2.826,0,5.575-1.118,7.563-3.138c2.004-1.996,3.138-4.72,3.138-7.555L460.782,276.588z"/><path d="M376.038,413.906c-16.602-48.848-60.471-82.445-111.113-87.018c-16.958,17.958-37.954,29.351-61.731,29.351c-23.759,0-44.771-11.392-61.713-29.351c-50.672,4.573-94.543,38.17-111.145,87.026l-9.177,27.013c-2.625,7.773-1.368,16.338,3.416,23.007c4.783,6.671,12.486,10.631,20.685,10.631h315.853c8.215,0,15.918-3.96,20.702-10.631c4.767-6.669,6.041-15.234,3.4-23.007L376.038,413.906z"/><path d="M120.842,206.782c0,60.589,36.883,125.603,82.352,125.603c45.487,0,82.368-65.014,82.368-125.603C285.563,81.188,120.842,80.939,120.842,206.782z"/></g></svg>
                        <span>Administrator</span>
                    </div>
                <% } else if (user.role === 'PIC') { %>
                    <div class="inline-flex items-center space-x-1.5 bg-indigo-100 text-indigo-800 text-xs font-semibold px-2.5 py-1 rounded-full">
                        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M19.75 14V11.75H22V10.25H19.75V8H18.25V10.25H16V11.75H18.25V14H19.75Z" /><path d="M11 4C8.79 4 7 5.79 7 8C7 10.21 8.79 12 11 12C13.21 12 15 10.21 15 8C15 5.79 13.21 4 11 4Z" /><path d="M3 18C3 15.34 8.33 14 11 14C13.67 14 19 15.34 19 18V20H3V18Z" /></svg>
                        <span>PIC</span>
                    </div>
                <% } else if (user.role === 'KIOSK') { %>
                    <div class="inline-flex items-center space-x-1.5 bg-teal-100 text-teal-800 text-xs font-semibold px-2.5 py-1 rounded-full">
                        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M8.5 8.5C8.5 6.56625 10.0662 5 12 5C13.9338 5 15.5 6.56625 15.5 8.5C15.5 10.4338 13.9338 12 12 12C10.0662 12 8.5 10.4338 8.5 8.5Z" /><path d="M12 13.75C9.66375 13.75 5 14.9225 5 17.25V19H19V17.25C19 14.9225 14.3363 13.75 12 13.75Z" /><path d="M21.4025 8.58002L21.99 9.17168L18.6567 12.505L16.99 10.8425L17.5817 10.255L18.6567 11.3259L21.4025 8.58002Z" /></svg>
                        <span>Petugas Kiosk</span>
                    </div>
                <% } else { %>
                    <div class="inline-flex items-center space-x-1.5 bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-1 rounded-full">
                        <svg fill="currentColor" class="w-3 h-3" viewBox="0 0 512 512"><path d="M448,362.7l-117.3-21.3C320,320,320,310.7,320,298.7c10.7-10.7,32-21.3,32-32c10.7-32,10.7-53.3,10.7-53.3c5.5-8,21.3-21.3,21.3-42.7s-21.3-42.7-21.3-53.3C362.7,32,319.2,0,256,0c-60.5,0-106.7,32-106.7,117.3c0,10.7-21.3,32-21.3,53.3s15.2,35.4,21.3,42.7c0,0,0,21.3,10.7,53.3c0,10.7,21.3,21.3,32,32c0,10.7,0,21.3-10.7,42.7L64,362.7C21.3,373.3,0,448,0,512h512C512,448,490.7,373.3,448,362.7z"/></svg>
                        <span>Anggota</span>
                    </div>
                <% } %>
            </div>
        </div>
        <!-- END FOTO PROFIL DAN BADGE ROLE -->

        <!-- QR dan info unik -->
        <div class="md:col-span-2 p-8 flex flex-col items-center justify-center">
            <h3 class="text-xl font-semibold text-gray-800">Kode QR Unik Anda</h3>
            <p class="text-gray-500 mt-1 mb-6">Tunjukkan kode ini kepada PIC untuk alokasi kuota internal.</p>
            
            <div id="qrcode" class="p-4 border border-dashed border-gray-300 rounded-lg"></div>

            <button id="download-button" class="mt-4 bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 flex items-center justify-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                <span>Unduh QR Code</span>
            </button>

            <div class="mt-6 w-full max-w-sm">
                <label for="uniqueId" class="block text-sm font-medium text-gray-700">ID Unik</label>
                <div class="mt-1 flex rounded-md shadow-sm">
                    <input type="text" id="uniqueId" value="<%= user.unique_user_id %>" readonly class="flex-1 block w-full rounded-none rounded-l-md border-gray-300 bg-gray-50 px-3 py-2 font-mono">
                    <button id="copy-button" type="button" class="relative -ml-px inline-flex items-center space-x-2 rounded-r-md border border-gray-300 bg-gray-100 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                        <span id="copy-text">Salin</span>
                    </button>
                </div>
            </div>
            <!-- FORM GANTI PASSWORD -->
            <div class="mt-10 w-full max-w-md bg-gray-50 rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Ganti Password</h3>
                <% if (locals.passwordError) { %>
                    <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-2 mb-4 text-sm"><%= locals.passwordError %></div>
                <% } %>
                <% if (locals.passwordSuccess) { %>
                    <div class="bg-green-100 border-l-4 border-green-500 text-green-700 p-2 mb-4 text-sm"><%= locals.passwordSuccess %></div>
                <% } %>
                <form action="/profile/change-password" method="POST" class="space-y-4">
                    <div>
                        <label for="oldPassword" class="block text-sm font-medium text-gray-700">Password Lama</label>
                        <input type="password" id="oldPassword" name="oldPassword" required class="mt-1 w-full px-3 py-2 border rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="newPassword" class="block text-sm font-medium text-gray-700">Password Baru</label>
                        <input type="password" id="newPassword" name="newPassword" required minlength="6" class="mt-1 w-full px-3 py-2 border rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="confirmPassword" class="block text-sm font-medium text-gray-700">Konfirmasi Password Baru</label>
                        <input type="password" id="confirmPassword" name="confirmPassword" required minlength="6" class="mt-1 w-full px-3 py-2 border rounded-md shadow-sm">
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">Simpan Password Baru</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
<script>
    // Generate QR Code
    const qrcodeContainer = document.getElementById('qrcode');
    const uniqueId = "<%= user.unique_user_id %>";

    if (qrcodeContainer) {
        new QRCode(qrcodeContainer, {
            text: uniqueId,
            width: 220,
            height: 220,
            colorDark : "#000000",
            colorLight : "#ffffff",
            correctLevel : QRCode.CorrectLevel.H
        });
    }

    // Copy Unique ID
    const copyButton = document.getElementById('copy-button');
    if (copyButton) {
        copyButton.addEventListener('click', function() {
            const uniqueIdInput = document.getElementById('uniqueId');
            const copyText = document.getElementById('copy-text');
            if (uniqueIdInput) {
                // Fallback untuk browser lama
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(uniqueIdInput.value).then(() => {
                        copyText.textContent = 'Tersalin!';
                        setTimeout(() => { copyText.textContent = 'Salin'; }, 2000);
                    });
                } else {
                    uniqueIdInput.select();
                    document.execCommand('copy');
                    copyText.textContent = 'Tersalin!';
                    setTimeout(() => { copyText.textContent = 'Salin'; }, 2000);
                }
            }
        });
    }

    // Download QR Code with white padding
    const downloadButton = document.getElementById('download-button');
    if (downloadButton) {
        downloadButton.addEventListener('click', () => {
            const qrCanvas = qrcodeContainer.querySelector('canvas');
            if (qrCanvas) {
                const padding = 20;
                const paddedCanvas = document.createElement('canvas');
                const paddedCtx = paddedCanvas.getContext('2d');

                paddedCanvas.width = qrCanvas.width + padding * 2;
                paddedCanvas.height = qrCanvas.height + padding * 2;

                paddedCtx.fillStyle = '#FFFFFF';
                paddedCtx.fillRect(0, 0, paddedCanvas.width, paddedCanvas.height);

                paddedCtx.drawImage(qrCanvas, padding, padding);

                const link = document.createElement('a');
                link.href = paddedCanvas.toDataURL('image/png');
                link.download = `qrcode-${uniqueId}.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                alert('Gagal mengunduh QR Code.');
            }
        });
    }
</script>

<%- include('partials/footer') %>