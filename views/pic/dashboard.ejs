<%- include('../partials/header') %>

<h1 class="text-3xl font-bold text-gray-800 mb-6">PIC Dashboard - Alokasi Kuota Internal</h1>

<% if (sessions.length > 0) { %>
    <div class="space-y-8">
        <% sessions.forEach(session => { %>
            <div class="bg-white p-6 rounded-lg shadow-md">
                <div>
                    <h2 class="text-xl font-bold text-blue-600"><%= session.event_name %></h2>
                    <p class="text-gray-500">Sesi: <%= new Date(session.start_time).toLocaleString('id-ID', { dateStyle: 'full', timeStyle: 'short' }) %></p>
                    <p class="text-gray-600 mt-2">Sisa Kuota Internal: 
                        <span class="font-bold text-green-600" id="quota-<%= session.id %>"><%= session.internal_quota %></span>
                    </p>
                </div>

                <hr class="my-4">

                <div class="flex items-center space-x-2">
                    <input type="text" id="user-input-<%= session.id %>" placeholder="Masukkan atau Pindai ID Unik" class="flex-grow px-3 py-2 border rounded-md">
                    <button type="button" onclick="addUser('<%= session.id %>')" class="bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-800">Tambah</button>
                </div>
                <div id="error-msg-<%= session.id %>" class="text-red-500 text-sm mt-1"></div>

                <form action="/pic/allocate-bulk" method="POST">
                    <input type="hidden" name="sessionId" value="<%= session.id %>">
                    
                    <div id="user-list-<%= session.id %>" class="mt-4 space-y-2">
                        </div>

                    <button type="submit" class="mt-4 w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-indigo-700">
                        Submit Semua Alokasi
                    </button>
                </form>
            </div>
        <% }) %>
    </div>
<% } else { %>
    <p class="text-center text-gray-500 mt-10">Tidak ada sesi dengan kuota internal yang bisa dialokasikan.</p>
<% } %>

<script>
    async function addUser(sessionId) {
        const input = document.getElementById(`user-input-${sessionId}`);
        const userList = document.getElementById(`user-list-${sessionId}`);
        const errorMsg = document.getElementById(`error-msg-${sessionId}`);
        const quotaSpan = document.getElementById(`quota-${sessionId}`);
        const uniqueUserId = input.value.trim();

        errorMsg.textContent = '';
        if (!uniqueUserId) return;

        // Check if user is already in the list
        if (document.querySelector(`input[name="userIds"][value-unique="${uniqueUserId}"]`)) {
            errorMsg.textContent = 'User ini sudah ada di dalam daftar.';
            return;
        }

        // Check if list exceeds quota
        const currentListCount = userList.children.length;
        if (currentListCount >= parseInt(quotaSpan.textContent)) {
            errorMsg.textContent = 'Jumlah user melebihi sisa kuota.';
            return;
        }
        
        try {
            // Validate user via API
            const response = await fetch('/pic/api/validate-user', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ uniqueUserId })
            });

            const result = await response.json();
            if (!result.success) {
                throw new Error(result.message);
            }

            // If valid, add to the list
            const user = result.user;
            const listItem = document.createElement('div');
            listItem.className = 'flex items-center justify-between bg-gray-100 p-2 rounded';
            listItem.innerHTML = `
                <span>${user.name} (${user.unique_user_id})</span>
                <input type="hidden" name="userIds" value="${user.id}" value-unique="${user.unique_user_id}">
                <button type="button" onclick="this.parentElement.remove()" class="text-red-500 hover:text-red-700">Hapus</button>
            `;
            userList.appendChild(listItem);
            input.value = ''; // Clear input
            input.focus();

        } catch (error) {
            errorMsg.textContent = error.message;
        }
    }

    // Allow adding user by pressing Enter
    document.querySelectorAll('input[id^="user-input-"]').forEach(input => {
        input.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const sessionId = this.id.split('-').pop();
                addUser(sessionId);
            }
        });
    });
</script>

<%- include('../partials/footer') %>